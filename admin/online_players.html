<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <title>Admin â€“ Online hrÃ¡Äi</title>
  <link rel="stylesheet" href="/css/admin.css">
</head>

<body class="admin-page">

<div id="adminHeader"></div>

<main class="auth-container">

  <section class="admin-card">

    <h2>Online hrÃ¡Äi</h2>

    <div style="margin-bottom:15px;">
      AktuÃ¡lnÄ› online:
      <strong id="onlineCount" class="online-badge">0</strong>
    </div>

    <table class="admin-table" id="onlineTable">
      <thead>
        <tr>
          <th data-key="char_name" data-type="text">POSTAVA</th>
          <th data-key="level" data-type="number">LEVEL</th>
          <th data-key="account_name" data-type="text">ÃšÄŒET</th>
          <th data-key="onlineTime" data-type="number">ODEHRÃNO</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

  </section>

</main>

<script>
let allPlayers = [];
let currentSort = { key: null, dir: 1 };

/* ===== LOAD DATA ===== */
async function loadOnlinePlayers() {
  try {
    const res = await fetch('/admin/api/list_online_players.php');
    const data = await res.json();

    if (!data.ok) return;

    allPlayers = data.players;

    document.getElementById('onlineCount').textContent = allPlayers.length;
    renderTable(allPlayers);

  } catch (e) {
    console.error("Chyba pÅ™i naÄÃ­tÃ¡nÃ­ online hrÃ¡ÄÅ¯:", e);
  }
}

/* ===== RENDER TABLE ===== */
function renderTable(players) {
  const tbody = document.querySelector('#onlineTable tbody');
  tbody.innerHTML = '';

  players.forEach(p => {

    const tr = document.createElement('tr');

    if (p.is_gm == 1) {
      tr.style.background = "rgba(61,220,151,0.08)";
    }

    tr.innerHTML = `
      <td>
        ${p.char_name}
        ${p.is_gm == 1 ? '<span style="margin-left:6px;padding:2px 8px;font-size:11px;font-weight:bold;border-radius:6px;background:#3ddc97;color:#0f5132;">GM</span>' : ''}
      </td>
      <td>${p.level}</td>
      <td>${p.account_name}</td>
      <td>${formatTime(p.onlineTime)}</td>
    `;

    tbody.appendChild(tr);
  });
}

/* ===== SORTING ===== */
function sortBy(key, type) {

  let dir = 1;

  if (currentSort.key === key) {
    dir = -currentSort.dir;
  }

  currentSort = { key, dir };

  const sorted = [...allPlayers].sort((a, b) => {

    let v1 = a[key];
    let v2 = b[key];

    if (type === 'text') {
      return v1.localeCompare(v2) * dir;
    }

    return (v1 - v2) * dir;
  });

  renderTable(sorted);
}

/* ===== TIME FORMAT ===== */
function formatTime(sec) {
  if (!sec) return "0h 0m";

  const h = Math.floor(sec / 3600);
  const m = Math.floor((sec % 3600) / 60);

  return `${h}h ${m}m`;
}

/* ===== HEADER EVENTS ===== */
document.querySelectorAll('#onlineTable th').forEach(th => {
  th.style.cursor = 'pointer';

  th.addEventListener('click', () => {
    sortBy(
      th.dataset.key,
      th.dataset.type
    );
  });
});

/* ===== INIT ===== */
loadOnlinePlayers();
setInterval(loadOnlinePlayers, 30000);
</script>

<script>
fetch('/admin/partials/admin_header.html')
  .then(r => r.text())
  .then(html => {
    document.getElementById('adminHeader').innerHTML = html;

    // ğŸ”¥ zvÃ½raznÄ›nÃ­ aktivnÃ­ strÃ¡nky
   const links = document.querySelectorAll('.admin-nav a');
const currentFile = window.location.pathname.split("/").pop();

links.forEach(link => {
  const linkFile = link.getAttribute('href').split("/").pop();

  if (currentFile === linkFile) {
    link.classList.add('active');
  }
});
  });
</script>


</body>
</html>
