<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <title>Bug detail | Admin</title>
  <link rel="stylesheet" href="/css/style.css">
</head>

<body class="auth-page profile-page">

<header class="main-header">
  <div class="logo"><a href="/">Ordo Draconis</a></div>
  <div class="auth">
    <a href="/admin/index.html" class="btn">Admin</a>
    <a href="/api/logout.php" class="btn">Odhlásit</a>
  </div>
</header>

<main class="auth-container profile-shell">

  <h1 id="bugTitle">Bug detail</h1>

  <a href="/admin/bug_reports.html" class="btn btn-secondary" style="margin-bottom:20px;">
    ← Zpět na přehled bug reportů
  </a>

  <div class="profile-card">

    <p><strong>User:</strong> <span id="bugUser"></span></p>
    <p><strong>Account:</strong> <span id="bugAccount"></span></p>
    <p><strong>Category:</strong> <span id="bugCategory"></span></p>
<div id="statusBadge" class="status-badge status-new">
  NEW
</div>
    <label>Status</label>
    <select id="bugStatus">
      <option value="new">NEW</option>
      <option value="in_progress">IN PROGRESS</option>
      <option value="resolved">RESOLVED</option>
      <option value="closed">CLOSED</option>
    </select>

    <!-- USER MESSAGE -->
    <div class="bug-user-message" style="margin-top:20px;">
      <h3>Reported issue (user message)</h3>
      <pre id="bugUserMessage" class="profile-card muted"></pre>
    </div>

    <!-- ADMIN REPLY -->
    <label style="margin-top:20px;">Admin reply</label>
    <div id="messageHistory"></div>

<textarea id="newMessage" rows="4"></textarea>
<button id="sendMessage">Odeslat odpověď</button>

    <button id="saveBtn" class="btn btn-primary" style="margin-top:20px;">
      Uložit
    </button>

  </div>

</main>

<script>
const params = new URLSearchParams(window.location.search);
const id = params.get('id');
const badge = document.getElementById('statusBadge');

function updateBadge(status) {
  badge.className = 'status-badge status-' + status;
  badge.textContent = status.replace('_', ' ').toUpperCase();
}

fetch(`/admin/api/get_bug_report.php?id=${id}`)
  .then(r => r.json())
  .then(data => {
    if (!data.ok) return;

    const b = data.bug;

    document.getElementById('bugTitle').textContent = b.title;
    document.getElementById('bugUser').textContent = b.email;
    document.getElementById('bugAccount').textContent = b.game_account || '-';
    document.getElementById('bugCategory').textContent = b.category;
    document.getElementById('bugStatus').value = b.status;
    updateBadge(b.status);
    document.getElementById('adminReply').value = b.admin_reply || '';

    const msg = document.getElementById('bugUserMessage');
    msg.textContent = b.message && b.message.trim()
      ? b.message
      : '⚠ Uživatel nepřiložil žádný popis problému.';
  });

document.getElementById('saveBtn').addEventListener('click', async () => {
  const payload = {
    id,
    status: document.getElementById('bugStatus').value,
    reply: document.getElementById('adminReply').value
  };

  const res = await fetch('/admin/api/update_bug_report.php', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });

  const data = await res.json();
  if (data.ok) {
    alert('Uloženo');
  } else {
    alert('Chyba při ukládání');
  }
});
document.getElementById('bugStatus').addEventListener('change', (e) => {
  updateBadge(e.target.value);
});

</script>
<script src="/js/bug-admin-detail.js"></script>
</body>
</html>
