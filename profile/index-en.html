<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Profile | Ordo Draconis</title>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/profile.css">
</head>

<body class="auth-page profile-page">

<header class="main-header">
  <div class="logo"><a href="/">Ordo Draconis</a></div>
  <div class="auth">
    <a href="/profile/index-en.html" class="btn active">Profile</a>
    <a href="/api/logout.php?lang=en" class="btn">Logout</a>
  </div>
</header>

<main class="auth-container profile-shell">
  <h1>My profile</h1>

  <div class="profile-tabs">
    <button type="button" class="tab active" data-tab="accounts">Accounts</button>
    <button type="button" class="tab" data-tab="vote">Server vote</button>
    <button type="button" class="tab" data-tab="donate">Donate</button>
    <button type="button" class="tab" data-tab="support">Bug report</button>
  </div>

  <div class="profile-panels">
    <section id="accounts" class="profile-card panel active">
      <h2>Game accounts</h2>
      <p class="muted">Create and manage your Lineage II accounts.</p>

      <a id="createAccBtn" class="btn btn-primary" href="#">Create game account</a>
      <div id="accModal" class="modal hidden">
  <div class="modal-box">
    <h3>Create game account</h3>

    <label>Login</label>
    <input id="accLogin" type="text" placeholder="4–16 characters (A–Z, 0–9, _)">

    <label>Password</label>
    <input id="accPass" type="password" placeholder="min. 6 characters">

 
    <div class="modal-actions">
      <button id="accCancel" class="btn">Cancel</button>
      <button id="accSubmit" class="btn btn-primary">Create</button>
    </div>

    <div id="accMsg" class="form-error" style="display:none;"></div>
  </div>
</div>
      <div id="gameAccountsList" class="mini-list"></div>
    </section>

    <section id="vote" class="profile-card panel">
      <h2>Server vote</h2>
      <p class="muted">Vote links will appear here (4–5 sites).</p>

      <div class="link-list">
        <a href="#" class="link-item">Vote site #1</a>
        <a href="#" class="link-item">Vote site #2</a>
        <a href="#" class="link-item">Vote site #3</a>
        <a href="#" class="link-item">Vote site #4</a>
      </div>
    </section>

    <section id="donate" class="profile-card panel">
      <h2>Donate</h2>
      <p class="muted">No pay-to-win. Token/payment info will be provided here.</p>

      <div class="donate-box">
        <div><strong>IBAN:</strong> XXXX XXXX XXXX</div>
        <div><strong>Message for recipient:</strong> your e-mail / account</div>
      </div>
    </section>

    <section id="support" class="profile-card panel">
      <h2>Ticket / Bug report</h2>
      <p class="muted">Something not working? Send us a ticket.</p>

      <a class="btn btn-primary" href="/support/" style="max-width:320px;">Submit ticket</a>
    </section>
  </div>
</main>
<script>
async function checkSession() {
  try {
    const res = await fetch('/api/me.php', { credentials: 'same-origin' });
    if (!res.ok) return false;
    const data = await res.json();
    return data.ok === true;
  } catch {
    return false;
  }
}

document.addEventListener('DOMContentLoaded', async () => {
  const ok = await checkSession();
  if (!ok) {
    const isEn = document.documentElement.lang === 'en';
    window.location.href = isEn
      ? '/auth/login-en.html'
      : '/auth/login.html';
  }
});
</script>



<script>
document.addEventListener('DOMContentLoaded', () => {
  const tabs = document.querySelectorAll('.profile-tabs .tab');
  const panels = document.querySelectorAll('.profile-panels .panel');

  const show = (key) => {
    tabs.forEach(t => t.classList.toggle('active', t.dataset.tab === key));
    panels.forEach(p => p.classList.toggle('active', p.id === key));
  };

  tabs.forEach(t => t.addEventListener('click', () => show(t.dataset.tab)));
  const first = document.querySelector('.profile-tabs .tab.active') || tabs[0];
  if (first) show(first.dataset.tab);
});
</script>

<script>
(() => {
  const modal = document.getElementById('accModal');
  const openBtn = document.getElementById('createAccBtn');
  const cancelBtn = document.getElementById('accCancel');
  const submitBtn = document.getElementById('accSubmit');
  const msg = document.getElementById('accMsg');

  const login = document.getElementById('accLogin');
  const pass  = document.getElementById('accPass');

  const open = () => { modal.classList.remove('hidden'); msg.style.display='none'; msg.textContent=''; };
  const close = () => { modal.classList.add('hidden'); };

  openBtn?.addEventListener('click', (e) => { e.preventDefault(); open(); });
  cancelBtn?.addEventListener('click', (e) => { e.preventDefault(); close(); });
  modal?.addEventListener('click', (e) => { if (e.target === modal) close(); });

  submitBtn?.addEventListener('click', async (e) => {
    e.preventDefault();
    msg.style.display='none';

   const payload = {
  login: login.value.trim(),
  password: pass.value
};
    submitBtn.disabled = true;
    try {
      const res = await fetch('/api/create_game_account.php', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      const data = await res.json().catch(()=> ({}));

      if (data.ok) {
  msg.style.display = 'block';
  msg.textContent = 'Done. Game account has been created.';

  pass.value = '';
  login.value = '';
  
  await loadGameAccounts();

  // zavřít modal po chvilce
  setTimeout(() => {
    modal.classList.add('hidden');
  }, 800);
}
          else {
        msg.style.display='block';
        msg.textContent = data.error || 'Error.';
      }
    } finally {
      submitBtn.disabled = false;
    }
  });
})();
</script>
<script>
async function loadGameAccounts() {
  const list = document.getElementById('gameAccountsList');
  list.innerHTML = '<div class="muted">Loading game accounts…</div>';

  let res;
  try {
    res = await fetch('/api/list_game_accounts.php');
  } catch (e) {
    list.innerHTML = '<div class="form-error">Server connection error.</div>';
    return;
  }

  if (!res.ok) {
    list.innerHTML = '<div class="form-error">Unable to load accounts.</div>';
    return;
  }

  const data = await res.json();

  list.innerHTML = '';

  if (!data.ok || !data.accounts.length) {
    list.innerHTML = '<div class="muted">You have no game accounts yet.</div>';
    return;
  }

  data.accounts.forEach(acc => {
    const row = document.createElement('div');
    row.className = 'mini-row';
   row.innerHTML = `
  <strong>Account:</strong> ${acc.login}
  <span class="tag">${acc.chars_count} characters</span>
  <span class="tag">${acc.created_at}</span>

  <div class="actions">
    <button class="btn btn-small btn-danger" data-login="${acc.login}">
      Delete
    </button>
    <button class="btn btn-small" data-reset="${acc.login}">
      Reset password
    </button>
  </div>
`;
    list.appendChild(row);
  });
}
</script>
<script>
document.addEventListener('click', async (e) => {
  const btn = e.target.closest('button[data-login]');
  if (!btn) return;

  const login = btn.dataset.login;
  const keyword = 'delete';

  const text = prompt(
    `Type "${keyword}" to confirm deletion of account "${login}"`
  );

  if (text !== keyword) {
    alert('Deletion cancelled.');
    return;
  }

  const res = await fetch('/api/delete_game_account.php', {
    method: 'POST',
    headers: {'Content-Type': 'application/json'},
    body: JSON.stringify({ login })
  });

  const data = await res.json();

  if (data.ok) {
    alert('Account deleted.');
    loadGameAccounts();
  } else {
    alert(data.error || 'Delete failed.');
  }
});
</script>

</body>
</html>
