<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Profile | Ordo Draconis</title>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/profile.css">
</head>

<body class="auth-page profile-page">

<header class="main-header">
  <div class="logo"><a href="/">Ordo Draconis</a></div>
  <div class="auth auth-center">
    <a href="/profile/index-en.html" class="btn active">Profile</a>
   <a href="/admin/index.html"
   class="btn admin-btn"
   id="adminBtn"
   style="display:none;">
  Admin panel
</a>
    <a href="/api/logout.php?lang=en" class="btn">Logout</a>
  </div>
</header>

<main class="auth-container profile-shell">
  <h1>My profile</h1>

  <div class="profile-tabs">
    <button type="button" class="tab active" data-tab="accounts">Accounts</button>
    <button type="button" class="tab" data-tab="vote">Server vote</button>
    <button type="button" class="tab" data-tab="donate">Donate</button>
    <button type="button" class="tab" data-tab="support">Bug report</button>
  </div>

  <div class="profile-panels">
    <section id="accounts" class="profile-card panel active">
      <h2>
  Game accounts
  <span id="accountsCount" class="muted" style="font-size:14px;">
    (0 / 10)
  </span>
</h2>
      <p class="muted">Create and manage your Lineage II accounts.</p>

      <a id="createAccBtn" class="btn btn-primary" href="#">Create game account</a>
      <div id="accModal" class="modal hidden">
  <div class="modal-box">
    <h3>Create game account</h3>

    <label>Login</label>
    <input id="accLogin" type="text" placeholder="4‚Äì16 characters (A‚ÄìZ, 0‚Äì9, _)">

    <label>Password</label>
    <input id="accPass" type="password" placeholder="min. 6 characters">

 
    <div class="modal-actions">
      <button id="accCancel" class="btn">Cancel</button>
      <button id="accSubmit" class="btn btn-primary">Create</button>
    </div>

    <div id="accMsg" class="form-error" style="display:none;"></div>
  </div>
</div>

<div id="deleteModal" class="modal hidden">
  <div class="modal-box">
    <h3 id="deleteTitle">Delete account</h3>

    <p id="deleteText">
      To confirm account deletion <strong id="deleteLogin"></strong>
      type <strong id="deleteKeyword">delete</strong>.
    </p>

    <input id="deleteConfirmInput" type="text" placeholder="type delete">

    <div class="modal-actions">
      <button id="deleteCancel" class="btn">Cancel</button>
      <button id="deleteConfirm" class="btn btn-danger" disabled>
        Delete account
      </button>
    </div>

    <div id="deleteMsg" class="form-error" style="display:none;"></div>
  </div>
</div>

<div id="resetModal" class="modal hidden">
  <div class="modal-box">
    <h3>Reset password</h3>

    <p>
      Enter a new password for your account <strong id="resetLogin"></strong>.
    </p>

    <input id="resetPass1" type="password" placeholder="New password (min. 6 characters)">
    <input id="resetPass2" type="password" placeholder="Password confirmation">

    <div class="modal-actions">
      <button id="resetCancel" class="btn">Cancel</button>
      <button id="resetConfirm" class="btn btn-primary" disabled>
        Change password
      </button>
    </div>

    <div id="resetMsg" class="form-error" style="display:none;"></div>
  </div>
</div>


      <div id="gameAccountsList" class="mini-list"></div>
    </section>

    <section id="vote" class="profile-card panel">
      <h2>Server vote</h2>
      <div id="voteBalance" class="wallet-balance">
  Vote Coin: <strong>0</strong>
      </div>
      <div id="dcBalance" class="wallet-balance">
  Dragon Coin: <strong>0</strong>
      </div>
      <p class="muted">Vote links will appear here (4‚Äì5 sites).</p>

      <div class="link-list">
  <div class="muted">Loading votes‚Ä¶</div>
</div>
<hr style="margin:20px 0;">
<button id="convertVcToDc" class="btn btn-primary">
    Convert 4 Vote Coin ‚Üí 1 Dragon Coin
  </button>
<button id="openVipModal" class="btn btn-primary">
  Activate VIP 24h
</button>

<div id="vipModal" class="modal hidden">
  <div class="modal-box">
    <h3>Activate VIP 24 Hours</h3>

    <label>Character</label>
    <select id="vipCharSelect"></select>

    <label>Currency</label>
    <select id="vipCurrency">
      <option value="VOTE_COIN">4 Vote Coin</option>
      <option value="DC">1 Dragon Coin</option>
    </select>

    <div class="modal-actions">
      <button id="vipCancel" class="btn">Cancel</button>
      <button id="vipConfirm" class="btn btn-primary">
        Activate
      </button>
    </div>
  </div>
</div>
    </section>

    <section id="donate" class="profile-card panel">
      <h2>Donate</h2>
      <p class="muted">No pay-to-win. Token/payment info will be provided here.</p>

      <div class="donate-box">
        <div><strong>IBAN:</strong> XXXX XXXX XXXX</div>
        <div><strong>Message for recipient:</strong> your e-mail / account</div>
      </div>
    </section>

   <section id="support" class="profile-card panel">
  <h2>Bug report</h2>
  <p class="muted">Something not working? Let us know.</p>

  <form id="bugForm">
    <label>Game account (optional)</label>
    <select id="bugAccount">
      <option value="">‚Äî select account ‚Äî</option>
    </select>

    <label>Category</label>
    <select id="bugCategory" required>
      <option value="">‚Äî select category ‚Äî</option>
      <option value="quest">Quest</option>
      <option value="npc">NPC / AI</option>
      <option value="item">Item</option>
      <option value="skill">Skill</option>
      <option value="login">Login</option>
      <option value="other">Other</option>
    </select>

    <label>Issue title</label>
    <input id="bugTitle" type="text" maxlength="40" required>

    <label>Issue description</label>
    <textarea id="bugMessage" rows="6" maxlength="1000" required></textarea>
    <div id="bugCounter" class="char-counter">0 / 1000</div>

    <button class="btn btn-primary" type="submit">
      Submit report
    </button>
  </form>

  <!-- üîΩ P≈òESNƒö SEM TO PAT≈ò√ç üîΩ -->
  <hr style="margin:30px 0;">

  <h3>My reports</h3>

  <div id="myBugs" class="link-list">
    <div class="muted">Loading reports‚Ä¶</div>
  </div>
</section>


  </div>
</main>
<script>
async function checkSession() {
  try {
    const res = await fetch('/api/me.php', { credentials: 'same-origin' });
    if (!res.ok) return false;
    const data = await res.json();
    return data.ok === true;
  } catch {
    return false;
  }
}

document.addEventListener('DOMContentLoaded', async () => {
  const ok = await checkSession();
  if (!ok) {
    const isEn = document.documentElement.lang === 'en';
    window.location.href = isEn
      ? '/auth/login-en.html'
      : '/auth/login.html';
  }
});
</script>




<script>
document.addEventListener('DOMContentLoaded', () => {
  const tabs = document.querySelectorAll('.profile-tabs .tab');
  const panels = document.querySelectorAll('.profile-panels .panel');

  const show = (key) => {
    tabs.forEach(t => t.classList.toggle('active', t.dataset.tab === key));
    panels.forEach(p => p.classList.toggle('active', p.id === key));
  };

  tabs.forEach(t => t.addEventListener('click', () => show(t.dataset.tab)));
  const first = document.querySelector('.profile-tabs .tab.active') || tabs[0];
  if (first) show(first.dataset.tab);
});
</script>

<script>
(() => {
  const modal = document.getElementById('accModal');
  const openBtn = document.getElementById('createAccBtn');
  const cancelBtn = document.getElementById('accCancel');
  const submitBtn = document.getElementById('accSubmit');
  const msg = document.getElementById('accMsg');

  const login = document.getElementById('accLogin');
  const pass  = document.getElementById('accPass');

  const open = () => { modal.classList.remove('hidden'); msg.style.display='none'; msg.textContent=''; };
  const close = () => { modal.classList.add('hidden'); };

  openBtn?.addEventListener('click', (e) => { e.preventDefault(); open(); });
  cancelBtn?.addEventListener('click', (e) => { e.preventDefault(); close(); });
  modal?.addEventListener('click', (e) => { if (e.target === modal) close(); });

  submitBtn?.addEventListener('click', async (e) => {
    e.preventDefault();
    msg.style.display='none';

   const payload = {
  login: login.value.trim(),
  password: pass.value
};
    submitBtn.disabled = true;
    try {
      const res = await fetch('/api/create_game_account.php', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      const data = await res.json().catch(()=> ({}));

      if (data.ok) {
  modal.classList.add('hidden');

  notify('success', 'Game account has been created');

  pass.value = '';
  login.value = '';
  
  await loadGameAccounts();

  // zav≈ô√≠t modal po chvilce
  setTimeout(() => {
    modal.classList.add('hidden');
  }, 800);
} else {
  notify('error', data.error || 'Failed to create game account');
      }
    } finally {
      submitBtn.disabled = false;
    }
  });
})();
</script>
<script>
async function loadGameAccounts() {
  const list = document.getElementById('gameAccountsList');
  const countEl = document.getElementById('accountsCount');

  list.innerHTML = '<div class="muted">Loading game accounts‚Ä¶</div>';

  let res;
  try {
    res = await fetch('/api/list_game_accounts.php');
  } catch (e) {
    list.innerHTML = '<div class="form-error">Server connection error.</div>';
    if (countEl) countEl.textContent = '(0 / 10)';
    return;
  }

  if (!res.ok) {
    list.innerHTML = '<div class="form-error">Unable to load accounts.</div>';
    if (countEl) countEl.textContent = '(0 / 10)';
    return;
  }

  const data = await res.json();

  // update account count
  if (countEl) {
    countEl.textContent = `(${data.accounts.length} / 10)`;
  }

  list.innerHTML = '';

  if (!data.ok || !data.accounts.length) {
    list.innerHTML = '<div class="muted">You have no game accounts yet.</div>';
    return;
  }

  data.accounts.forEach(acc => {
    const row = document.createElement('div');
    row.className = 'mini-row';

    const isPrimary = Number(acc.is_primary) === 1;

    if (isPrimary) {
      row.classList.add('primary-account');
    }

    // ===== PREMIUM STATUS TAG =====
    let premiumTag = '<span class="tag muted">Premium: inactive</span>';

    if (acc.premium_days_left !== null) {
      if (acc.premium_days_left < 0) {
        premiumTag = '<span class="tag danger">Premium: expired</span>';
      } else if (acc.premium_days_left <= 3) {
        premiumTag = `
          <span class="tag warning">
            Premium: ${acc.premium_days_left} days left
          </span>`;
      } else {
        premiumTag = `
          <span class="tag success">
            Premium: ${acc.premium_days_left} days left
          </span>`;
      }
    }

    row.innerHTML = `
  <div class="account-row" data-login="${acc.login}">
    <strong>${isPrimary ? '‚≠ê ' : ''}Account:</strong> ${acc.login}

    <span class="tag">${acc.chars_count} characters</span>
    ${premiumTag}
    <span class="tag">${acc.created_at}</span>

    <div class="actions">
      ${isPrimary
        ? '<span class="tag primary">PRIMARY</span>'
        : `<button class="btn btn-small" data-primary="${acc.login}">Set primary</button>`
      }
      <button class="btn btn-small btn-danger" data-login="${acc.login}">Delete</button>
      <button class="btn btn-small" data-reset="${acc.login}">Change password</button>
    </div>
  </div>

  <div class="char-list hidden" id="chars-${acc.login}"></div>
`;



    list.appendChild(row);
  });
}
</script>


<script>
document.addEventListener('DOMContentLoaded', () => {
  loadGameAccounts();
});
</script>

<script>
(() => {
  const modal = document.getElementById('deleteModal');
  const input = document.getElementById('deleteConfirmInput');
  const confirmBtn = document.getElementById('deleteConfirm');
  const cancelBtn = document.getElementById('deleteCancel');

  let currentLogin = null;
  const keyword = 'delete';

  document.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-login]');
    if (!btn) return;

    currentLogin = btn.dataset.login;

    document.getElementById('deleteLogin').textContent = currentLogin;
    document.getElementById('deleteKeyword').textContent = keyword;
    input.value = '';
    confirmBtn.disabled = true;

    modal.classList.remove('hidden');
  });

  input.addEventListener('input', () => {
    confirmBtn.disabled = input.value.trim() !== keyword;
  });

  cancelBtn.addEventListener('click', () => {
    modal.classList.add('hidden');
  });

  confirmBtn.addEventListener('click', async () => {
    confirmBtn.disabled = true;

    const res = await fetch('/api/delete_game_account.php', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ login: currentLogin })
    });

    const data = await res.json().catch(() => ({}));

    if (data.ok) {
      modal.classList.add('hidden');
      notify('success', 'Game account deleted');
      await loadGameAccounts();
      return;
    }

    if (data.error === 'ACCOUNT_HAS_ACTIVE_CHARACTERS') {
      notify('error', 'Account has active characters');
    } else {
      notify('error', 'Failed to delete account');
    }

    confirmBtn.disabled = false;
  });
})();
</script>


<script>
(() => {
  const modal = document.getElementById('resetModal');
  const loginEl = document.getElementById('resetLogin');
  const pass1 = document.getElementById('resetPass1');
  const pass2 = document.getElementById('resetPass2');
  const confirmBtn = document.getElementById('resetConfirm');
  const cancelBtn = document.getElementById('resetCancel');

  let currentLogin = null;

  document.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-reset]');
    if (!btn) return;

    currentLogin = btn.dataset.reset;
    loginEl.textContent = currentLogin;
    pass1.value = '';
    pass2.value = '';
    confirmBtn.disabled = true;

    modal.classList.remove('hidden');
  });

  const validate = () => {
    confirmBtn.disabled =
      pass1.value.length < 6 || pass1.value !== pass2.value;
  };

  pass1.addEventListener('input', validate);
  pass2.addEventListener('input', validate);

  cancelBtn.addEventListener('click', () => {
    modal.classList.add('hidden');
  });

  confirmBtn.addEventListener('click', async () => {
    confirmBtn.disabled = true;

    const res = await fetch('/api/reset_game_password.php', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        login: currentLogin,
        password: pass1.value
      })
    });

    const data = await res.json().catch(() => ({}));

    if (data.ok) {
      modal.classList.add('hidden');
      notify('success', 'Password has been changed');
      return;
    }

    notify('error', data.error || 'Failed to reset password');
    confirmBtn.disabled = false;
  });
})();
</script>


<script>
function notify(type, message, timeout = 3000) {
  const box = document.getElementById('notifications');
  if (!box) return;

  const el = document.createElement('div');
  el.className = `notify ${type}`;
  el.textContent = message;

  box.appendChild(el);

  setTimeout(() => {
    el.style.opacity = '0';
    setTimeout(() => el.remove(), 300);
  }, timeout);
}
</script>

<script>
document.addEventListener('click', async (e) => {
  const btn = e.target.closest('button[data-primary]');
  if (!btn) return;

  const login = btn.dataset.primary;

  const res = await fetch('/api/set_primary_account.php', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ login })
  });

  const data = await res.json().catch(() => ({}));

  if (data.ok) {
    notify('success', 'Primary account set');
    loadGameAccounts();
  } else {
    notify('error', 'Failed to set primary account');
  }
});
</script>


<div id="notifications"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const accountSelect = document.getElementById('bugAccount');
  if (!accountSelect) return;

  fetch('/api/list_game_accounts.php')
    .then(r => r.json())
    .then(data => {
      if (!data.ok) return;
      data.accounts.forEach(acc => {
        const opt = document.createElement('option');
        opt.value = acc.login;
        opt.textContent = acc.login;
        accountSelect.appendChild(opt);
      });
    });
});

document.getElementById('bugForm')?.addEventListener('submit', async (e) => {
  e.preventDefault();

  const payload = {
    game_account: document.getElementById('bugAccount').value,
    category: document.getElementById('bugCategory').value,
    title: document.getElementById('bugTitle').value.trim(),
    message: document.getElementById('bugMessage').value.trim()
  };
if (payload.message.length > 1000) {
  notify('error', 'Message is too long (max 1000 characters)');
  return;
}
  const res = await fetch('/api/create_bug_report.php', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });

  const data = await res.json().catch(() => ({}));

  if (data.ok) {
    notify('success', 'Bug report odesl√°n');
    e.target.reset();
  } else {
    notify('error', data.error || 'Chyba p≈ôi odes√≠l√°n√≠');
  }
});
</script>

<script>
(() => {
  const textarea = document.getElementById('bugMessage');
  const counter  = document.getElementById('bugCounter');
  const max = 1000;

  if (!textarea || !counter) return;

  const update = () => {
    const len = textarea.value.length;
    counter.textContent = `${len} / ${max}`;

    counter.classList.remove('warning', 'danger');

if (len > 950) {
  counter.classList.add('danger');
} else if (len > 800) {
  counter.classList.add('warning');
}

  };

  textarea.addEventListener('input', update);
  update();
})();
</script>
<script>
fetch('/api/me.php', { credentials: 'same-origin' })
  .then(res => res.json())
  .then(data => {
    if (data.ok && data.role === 'admin') {
      const btn = document.getElementById('adminBtn');
      if (btn) btn.style.display = 'inline-flex';
    }
  })
  .catch(() => {
    // nic ‚Äì kdy≈æ se nepovede, admin panel se prostƒõ neuk√°≈æe
  });
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const box = document.getElementById('myBugs');
  if (!box) return;

  fetch('/api/list_my_bug_reports.php')
    .then(r => r.json())
    .then(data => {
      if (!data.ok) {
        box.innerHTML = '<div class="muted">No reports</div>';
        return;
      }

      box.innerHTML = '';

      data.bugs.forEach(bug => {
        const row = document.createElement('a');
        row.href = `/profile/bug_detail.html?id=${bug.id}`;
        row.className = 'link-item';

        row.innerHTML = `
          <strong>[${bug.status.toUpperCase()}]</strong>
          ${bug.title}
        `;

        box.appendChild(row);
      });
    });
});
</script>

<script>
async function loadVipMap(login) {
  const res = await fetch(`/api/list_characters_with_vip.php?account=${encodeURIComponent(login)}`);
  const data = await res.json();

  const map = {};
  if (data.ok && Array.isArray(data.characters)) {
    data.characters.forEach(ch => {
      map[ch.charId] = !!ch.has_vip;
    });
  }
  return map;
}
</script>


<script>
document.addEventListener('click', async (e) => {
  const row = e.target.closest('.account-row');
  if (!row) return;

  const login = row.dataset.login;
  const box = document.getElementById('chars-' + login);
  if (!box) return;

  if (!box.classList.contains('hidden')) {
    box.classList.add('hidden');
    box.innerHTML = '';
    return;
  }

  box.classList.remove('hidden');
  box.innerHTML = '<div class="muted">Loading characters‚Ä¶</div>';

  try {
    const vipMap = await loadVipMap(login);

    const res = await fetch(`/api/list_characters.php?account=${encodeURIComponent(login)}`);
    const data = await res.json();

    if (!data.ok || !data.characters.length) {
      box.innerHTML = '<div class="muted">No characters</div>';
      return;
    }

    box.innerHTML = '';

    data.characters.forEach(ch => {
      const el = document.createElement('div');
      el.className = 'char-row';

      const hasVip = vipMap[ch.charId];
      const vipTag = hasVip
        ? '<span class="tag vip">VIP</span>'
        : '';

      el.innerHTML = `
        <span><strong>${ch.char_name}</strong></span>
        <span>Lv ${ch.level}</span>
        <span class="${ch.online ? 'online' : 'offline'}">
          ${ch.online ? 'ONLINE' : 'offline'}
        </span>
        ${vipTag}
      `;

      box.appendChild(el);
    });

  } catch (err) {
    box.innerHTML = '<div class="form-error">Failed to load characters</div>';
  }
});
</script>

<script>
let voteCache = [];

/* Naƒçten√≠ vote web≈Ø */
async function loadVoteSites() {
  try {
    const res = await fetch('/api/vote_status.php');
    const data = await res.json();
    if (!data.ok) return;

    voteCache = data.sites;

    const box = document.querySelector('#vote .link-list');
    if (!box) return;

    box.innerHTML = '';

    if (!voteCache.length) {
      box.innerHTML = '<div class="muted">≈Ω√°dn√© aktivn√≠ vote weby.</div>';
      return;
    }

    voteCache.forEach(site => {
      const el = document.createElement('div');

      const status = site.remaining > 0
        ? `${Math.ceil(site.remaining / 3600)}h`
        : 'READY';

      const disabled = site.remaining > 0 ? 'disabled' : '';

      el.innerHTML = `
        <button class="btn vote-btn" data-id="${site.id}" ${disabled}>
          ${site.name} ‚Äì ${status}
        </button>
      `;

      box.appendChild(el);
    });

  } catch (err) {
    console.error('Vote load error:', err);
  }
}

/* Spu≈°tƒõn√≠ vote (vytvo≈ô√≠ attempt + otev≈ôe URL) */
async function startVote(siteId) {
  try {
    const res = await fetch('/api/vote_start.php', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ site_id: siteId })
    });

    const data = await res.json();

    if (!data.ok) {
      if (data.error === 'COOLDOWN') {
        const rem = typeof data.remaining === 'number' ? data.remaining : 0;
        alert('This vote is on cooldown. Time left: ' + rem + 's');
        loadVoteSites();
        return;
      }
      alert('Error: ' + (data.error || 'UNKNOWN'));
      return;
    }

    // otev≈ôi vote str√°nku
    window.open(data.vote_url, '_blank');

    // po chvilce: manual confirm (fallback) + polling check
    setTimeout(async () => {
      const confirmVote = confirm('Confirm voting? (The reward will be granted only after verification or manual confirmation.)');
      await pollVote(data.attempt_id, confirmVote);
    }, 6000);

  } catch (err) {
    console.error('Vote start error:', err);
    alert('Failed to start voting..');
  }
}

/* Polling vote_check */
async function pollVote(attemptId, manualConfirm) {
  const start = Date.now();
  const maxMs = 60000; // 60s
  const waitMs = 5000; // 5s

  while (Date.now() - start < maxMs) {
    try {
      const res = await fetch('/api/vote_check.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ attempt_id: attemptId, confirm: manualConfirm })
      });

      const data = await res.json();

      if (!data.ok) {
        if (data.error === 'COOLDOWN') {
          alert('This vote is on cooldown.');
          loadVoteSites();
          return;
        }
        alert('Chyba: ' + (data.error || 'UNKNOWN'));
        return;
      }

      // hotovo
      if (data.status === 'REWARDED' || data.status === 'USED') {
        alert('Vote Coin added!');
        loadVoteSites();
        if (typeof loadVoteBalance === 'function') loadVoteBalance();
        return;
      }

      // ƒçek√°me: POSTBACK pending / waiting_confirm
      // pokud user dal "Storno", status bude WAITING_CONFIRM a my jen ƒçek√°me do timeoutu
      await new Promise(r => setTimeout(r, waitMs));

    } catch (err) {
      console.error('Vote check error:', err);
      // p≈ôi chybƒõ ƒçekneme a zkus√≠me znovu
      await new Promise(r => setTimeout(r, waitMs));
    }
  }

  alert('Vote not detected yet. Please try again later.');
  loadVoteSites();
}

/* Kliknut√≠ na vote */
document.addEventListener('click', (e) => {
  const btn = e.target.closest('.vote-btn');
  if (!btn) return;

  const id = parseInt(btn.dataset.id, 10);
  if (!id) return;

  // rovnou startVote (attempt + otev≈ôen√≠ URL + ovƒõ≈ôen√≠)
  startVote(id);
});

/* inicializace */
document.addEventListener('DOMContentLoaded', loadVoteSites);
</script>


<script>
async function loadVoteBalance() {
  try {
    const res = await fetch('/api/get_wallet_balance.php?currency=VOTE_COIN');
    const data = await res.json();
    if (!data.ok) return;

    const el = document.querySelector('#voteBalance strong');
    if (el) {
      el.textContent = data.balance;
    }

  } catch (err) {
    console.error('Vote balance error:', err);
  }
}

async function loadDcBalance() {
  try {
    const res = await fetch('/api/get_wallet_balance.php?currency=DC');
    const data = await res.json();
    if (!data.ok) return;

    const el = document.querySelector('#dcBalance strong');
    if (el) {
      el.textContent = data.balance;
    }

  } catch (err) {
    console.error('DC balance error:', err);
  }
}

/* üîÑ naƒçten√≠ obou p≈ôi startu str√°nky */
document.addEventListener('DOMContentLoaded', () => {
  loadVoteBalance();
  loadDcBalance();
});
</script>

<script>
async function loadAllCharactersForVip() {
  const select = document.getElementById('vipCharSelect');
  select.innerHTML = '';

  const resAcc = await fetch('/api/list_game_accounts.php');
  const dataAcc = await resAcc.json();
  if (!dataAcc.ok) return;

  for (const acc of dataAcc.accounts) {
    const resChar = await fetch(`/api/list_characters.php?account=${encodeURIComponent(acc.login)}`);
    const dataChar = await resChar.json();
    if (!dataChar.ok) continue;

    dataChar.characters.forEach(ch => {
      const opt = document.createElement('option');
      opt.value = ch.charId;
      opt.textContent = `${ch.char_name} (Lv ${ch.level})`;
      select.appendChild(opt);
    });
  }
}

document.getElementById('openVipModal')?.addEventListener('click', async () => {
  await loadAllCharactersForVip();
  document.getElementById('vipModal').classList.remove('hidden');
});

document.getElementById('vipCancel')?.addEventListener('click', () => {
  document.getElementById('vipModal').classList.add('hidden');
});

document.getElementById('vipConfirm')?.addEventListener('click', async (e) => {

  const btn = e.target;
  if (btn.disabled) return;

  btn.disabled = true;
  btn.textContent = 'Activating...';

  const charId = document.getElementById('vipCharSelect').value;
  const currency = document.getElementById('vipCurrency').value;

  try {
    const res = await fetch('/api/activate_vip_24h.php', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
        char_id: charId,
        currency: currency
      })
    });

    const data = await res.json();

    if (data.ok) {
      document.getElementById('vipModal').classList.add('hidden');
      loadVoteBalance();
      loadDcBalance();
    } else {
      alert(data.error || 'Activation failed.');
    }

  } catch (err) {
    alert('Server error.');
  }

  btn.disabled = false;
  btn.textContent = 'Activate';
});
</script>

<script>
document.getElementById('convertVcToDc')?.addEventListener('click', async (e) => {

  const btn = e.target;
  if (btn.disabled) return;

  if (!confirm('Convert 4 Vote Coin into 1 Dragon Coin?')) {
    return;
  }

  btn.disabled = true;
  btn.textContent = 'Processing...';

  try {
    const res = await fetch('/api/convert_vc_to_dc.php', {
      method: 'POST',
      headers: {'Content-Type':'application/json'}
    });

    const data = await res.json();

    if (data.ok) {
      loadVoteBalance();
      loadDcBalance();
    } else {
      alert(data.error || 'Conversion failed.');
    }

  } catch (err) {
    alert('Server error.');
  }

  btn.disabled = false;
  btn.textContent = 'Convert 4 Vote Coin ‚Üí 1 Dragon Coin';
});
</script>

</body>
</html>
