<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Profile | Ordo Draconis</title>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/profile.css">
</head>

<body class="auth-page profile-page">

<header class="main-header">
  <div class="logo"><a href="/">Ordo Draconis</a></div>
  <div class="auth">
    <a href="/profile/index-en.html" class="btn active">Profile</a>
    <a href="/api/logout.php?lang=en" class="btn">Logout</a>
  </div>
</header>

<main class="auth-container profile-shell">
  <h1>My profile</h1>

  <div class="profile-tabs">
    <button type="button" class="tab active" data-tab="accounts">Game accounts</button>
    <button type="button" class="tab" data-tab="vote">Server vote</button>
    <button type="button" class="tab" data-tab="donate">Donate</button>
    <button type="button" class="tab" data-tab="support">Bug report</button>
  </div>

  <div class="profile-panels">
    <section id="accounts" class="profile-card panel active">
      <h2>
        Game accounts
        <span id="accountsCount" class="muted" style="font-size:14px;">
          (0 / 10)
        </span>
      </h2>

      <p class="muted">Create and manage your Lineage II accounts.</p>

      <a id="createAccBtn" class="btn btn-primary" href="#">Create game account</a>

      <!-- CREATE ACCOUNT MODAL -->
      <div id="accModal" class="modal hidden">
        <div class="modal-box">
          <h3>Create game account</h3>

          <label>Login</label>
          <input id="accLogin" type="text" placeholder="4–16 characters (A–Z, 0–9, _)">

          <label>Password</label>
          <input id="accPass" type="password" placeholder="min. 6 characters">

          <div class="modal-actions">
            <button id="accCancel" class="btn">Cancel</button>
            <button id="accSubmit" class="btn btn-primary">Create</button>
          </div>

          <div id="accMsg" class="form-error" style="display:none;"></div>
        </div>
      </div>

      <!-- DELETE MODAL -->
      <div id="deleteModal" class="modal hidden">
        <div class="modal-box">
          <h3>Delete account</h3>

          <p>
            To confirm deletion of <strong id="deleteLogin"></strong>,
            type <strong id="deleteKeyword">delete</strong>.
          </p>

          <input id="deleteConfirmInput" type="text" placeholder="type delete">

          <div class="modal-actions">
            <button id="deleteCancel" class="btn">Cancel</button>
            <button id="deleteConfirm" class="btn btn-danger" disabled>
              Delete account
            </button>
          </div>

          <div id="deleteMsg" class="form-error" style="display:none;"></div>
        </div>
      </div>

      <!-- RESET MODAL -->
      <div id="resetModal" class="modal hidden">
        <div class="modal-box">
          <h3>Reset password</h3>

          <p>
            Enter a new password for account <strong id="resetLogin"></strong>.
          </p>

          <input id="resetPass1" type="password" placeholder="New password (min. 6 characters)">
          <input id="resetPass2" type="password" placeholder="Confirm password">

          <div class="modal-actions">
            <button id="resetCancel" class="btn">Cancel</button>
            <button id="resetConfirm" class="btn btn-primary" disabled>
              Change password
            </button>
          </div>

          <div id="resetMsg" class="form-error" style="display:none;"></div>
        </div>
      </div>

      <div id="gameAccountsList" class="mini-list"></div>
    </section>

    <section id="vote" class="profile-card panel">
      <h2>Server vote</h2>
      <p class="muted">Vote links will be available here.</p>
    </section>

    <section id="donate" class="profile-card panel">
      <h2>Donate</h2>
      <p class="muted">No pay-to-win. Donation info will be available here.</p>
    </section>

    <section id="support" class="profile-card panel">
      <h2>Bug report</h2>
      <p class="muted">Something not working? Send us a ticket.</p>
      <a class="btn btn-primary" href="/support/">Submit ticket</a>
    </section>
  </div>
</main>

<script>
async function checkSession() {
  try {
    const res = await fetch('/api/me.php', { credentials: 'same-origin' });
    if (!res.ok) return false;
    const data = await res.json();
    return data.ok === true;
  } catch {
    return false;
  }
}

document.addEventListener('DOMContentLoaded', async () => {
  const ok = await checkSession();
  if (!ok) {
    window.location.href = '/auth/login-en.html';
  }
});
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const tabs = document.querySelectorAll('.profile-tabs .tab');
  const panels = document.querySelectorAll('.profile-panels .panel');

  const show = (key) => {
    tabs.forEach(t => t.classList.toggle('active', t.dataset.tab === key));
    panels.forEach(p => p.classList.toggle('active', p.id === key));
  };

  tabs.forEach(t => t.addEventListener('click', () => show(t.dataset.tab)));
  show(tabs[0].dataset.tab);
});
</script>

<script>
async function loadGameAccounts() {
  const list = document.getElementById('gameAccountsList');
  const countEl = document.getElementById('accountsCount');

  list.innerHTML = '<div class="muted">Loading game accounts…</div>';

  const res = await fetch('/api/list_game_accounts.php');
  const data = await res.json();

  if (countEl) {
    countEl.textContent = `(${data.accounts.length} / 10)`;
  }

  list.innerHTML = '';

  if (!data.ok || !data.accounts.length) {
    list.innerHTML = '<div class="muted">You have no game accounts yet.</div>';
    return;
  }

  data.accounts.forEach(acc => {
    const row = document.createElement('div');
    row.className = 'mini-row';

    const isPrimary = Number(acc.is_primary) === 1;
    if (isPrimary) row.classList.add('primary-account');

    row.innerHTML = `
      <strong>${isPrimary ? '⭐ ' : ''}Account:</strong> ${acc.login}
      <span class="tag">${acc.chars_count} characters</span>
      <span class="tag">${acc.created_at}</span>

      <div class="actions">
        ${
          isPrimary
            ? '<span class="tag primary">PRIMARY</span>'
            : `<button class="btn btn-small" data-primary="${acc.login}">
                 Set primary
               </button>`
        }
        <button class="btn btn-small btn-danger" data-login="${acc.login}">
          Delete
        </button>
        <button class="btn btn-small" data-reset="${acc.login}">
          Reset password
        </button>
      </div>
    `;

    list.appendChild(row);
  });
}

document.addEventListener('DOMContentLoaded', loadGameAccounts);
</script>

<script>
document.addEventListener('click', async (e) => {
  const btn = e.target.closest('button[data-primary]');
  if (!btn) return;

  const res = await fetch('/api/set_primary_account.php', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ login: btn.dataset.primary })
  });

  const data = await res.json();
  if (data.ok) {
    notify('success', 'Primary account set');
    loadGameAccounts();
  } else {
    notify('error', 'Failed to set primary account');
  }
});
</script>

<div id="notifications"></div>
</body>
</html>
