<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <title>Profil | Ordo Draconis</title>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/profile.css">
</head>

<body class="auth-page profile-page">

<header class="main-header">
  <div class="logo"><a href="/">Ordo Draconis</a></div>
  <div class="auth">
    <a href="/profile/index.html" class="btn active">Profil</a>
    <a href="/admin/index.html"
   id="adminBtn"
   class="btn"
   style="display:none; background:#8b6f1a;">
  Admin panel
</a>
    <a href="/api/logout.php?lang=cs" class="btn">Odhlásit se</a>
  </div>
</header>

<main class="auth-container profile-shell">
  <h1>Můj profil</h1>

  <div class="profile-tabs">
    <button type="button" class="tab active" data-tab="accounts">Herní účty</button>
    <button type="button" class="tab" data-tab="vote">Hlasování pro server</button>
    <button type="button" class="tab" data-tab="donate">Podpora serveru</button>
    <button type="button" class="tab" data-tab="support">Hlášení bugů</button>
  </div>

  <div class="profile-panels">
    <section id="accounts" class="profile-card panel active">
      <h2>
  Herní účty
  <span id="accountsCount" class="muted" style="font-size:14px;">
    (0 / 10)
  </span>
</h2>
      <p class="muted">Zde si vytvoříš a spravuješ své účty pro Lineage II.</p>

      <a id="createAccBtn" class="btn btn-primary" href="#">Vytvořit herní účet</a>

      <div id="accModal" class="modal hidden">
        <div class="modal-box">
          <h3>Vytvořit herní účet</h3>

          <label>Login</label>
          <input id="accLogin" type="text" placeholder="4–16 znaků (A–Z, 0–9, _)">

          <label>Heslo</label>
          <input id="accPass" type="password" placeholder="min. 6 znaků">

          <div class="modal-actions">
            <button id="accCancel" class="btn">Zrušit</button>
            <button id="accSubmit" class="btn btn-primary">Vytvořit</button>
          </div>

          <div id="accMsg" class="form-error" style="display:none;"></div>
        </div>
      </div>

<div id="deleteModal" class="modal hidden">
  <div class="modal-box">
    <h3 id="deleteTitle">Smazat účet</h3>

    <p id="deleteText">
      Pro potvrzení smazání účtu <strong id="deleteLogin"></strong>
      napiš <strong id="deleteKeyword">smazat</strong>.
    </p>

    <input id="deleteConfirmInput" type="text" placeholder="napiš smazat">

    <div class="modal-actions">
      <button id="deleteCancel" class="btn">Zrušit</button>
      <button id="deleteConfirm" class="btn btn-danger" disabled>
       Smazat účet
      </button>
    </div>

    <div id="deleteMsg" class="form-error" style="display:none;"></div>
  </div>
</div>

<div id="resetModal" class="modal hidden">
  <div class="modal-box">
    <h3>Reset hesla</h3>

    <p>
      Zadej nové heslo pro účet <strong id="resetLogin"></strong>.
    </p>

    <input id="resetPass1" type="password" placeholder="Nové heslo (min. 6 znaků)">
    <input id="resetPass2" type="password" placeholder="Potvrzení hesla">

    <div class="modal-actions">
      <button id="resetCancel" class="btn">Zrušit</button>
      <button id="resetConfirm" class="btn btn-primary" disabled>
        Změnit heslo
      </button>
    </div>

    <div id="resetMsg" class="form-error" style="display:none;"></div>
  </div>
</div>


      <div id="gameAccountsList" class="mini-list"></div>
    </section>

    <section id="vote" class="profile-card panel">
      <h2>Hlasování pro server</h2>
      <p class="muted">Odkazy na hlasování budou zde (4–5 webů).</p>

      <div class="link-list">
        <a href="#" class="link-item">Hlasování #1</a>
        <a href="#" class="link-item">Hlasování #2</a>
        <a href="#" class="link-item">Hlasování #3</a>
        <a href="#" class="link-item">Hlasování #4</a>
      </div>
    </section>

      <section id="donate" class="profile-card panel">
  <h2>Podpora serveru</h2>
  <p class="muted">Žádné pay-to-win. Zde budou informace k podpoře serveru.</p>

  <div class="donate-box">
    <div><strong>IBAN:</strong> XXXX XXXX XXXX</div>
    <div><strong>Zpráva pro příjemce:</strong> tvůj e-mail / účet</div>
  </div>
</section>

    <section id="support" class="profile-card panel">
  <h2>Hlášení bugů</h2>
  <p class="muted">Něco nefunguje? Pošli nám detailní popis problému.</p>

  <form id="bugForm">
    <label>Herní účet (volitelné)</label>
    <select id="bugAccount">
      <option value="">— vyber účet —</option>
    </select>

    <label>Kategorie</label>
    <select id="bugCategory" required>
      <option value="">— vyber kategorii —</option>
      <option value="quest">Quest</option>
      <option value="npc">NPC / AI</option>
      <option value="item">Item</option>
      <option value="skill">Skill</option>
      <option value="login">Přihlášení</option>
      <option value="other">Jiné</option>
    </select>

    <label>Název problému</label>
    <input id="bugTitle" type="text" maxlength="40" required>

    <label>Popis problému</label>
    <textarea id="bugMessage" rows="6" maxlength="1000" required></textarea>
    <div id="bugCounter" class="char-counter">0 / 1000</div>
    <button class="btn btn-primary" type="submit">
      Odeslat hlášení
    </button>
  </form>
</section>

  </div>
</main>

<script>
async function checkSession() {
  try {
    const res = await fetch('/api/me.php', { credentials: 'same-origin' });
    if (!res.ok) return false;
    const data = await res.json();
    return data.ok === true;
  } catch {
    return false;
  }
}

document.addEventListener('DOMContentLoaded', async () => {
  const ok = await checkSession();
  if (!ok) {
    const isEn = document.documentElement.lang === 'en';
    window.location.href = isEn
      ? '/auth/login-en.html'
      : '/auth/login.html';
  }
});
</script>



<script>
document.addEventListener('DOMContentLoaded', () => {
  const tabs = document.querySelectorAll('.profile-tabs .tab');
  const panels = document.querySelectorAll('.profile-panels .panel');

  const show = (key) => {
    tabs.forEach(t => t.classList.toggle('active', t.dataset.tab === key));
    panels.forEach(p => p.classList.toggle('active', p.id === key));
  };
  tabs.forEach(t => t.addEventListener('click', () => show(t.dataset.tab)));
  const first = document.querySelector('.profile-tabs .tab.active') || tabs[0];
  if (first) show(first.dataset.tab);
});
</script>

<script>
(() => {
  const modal = document.getElementById('accModal');
  const openBtn = document.getElementById('createAccBtn');
  const cancelBtn = document.getElementById('accCancel');
  const submitBtn = document.getElementById('accSubmit');
  const msg = document.getElementById('accMsg');

  const login = document.getElementById('accLogin');
  const pass  = document.getElementById('accPass');

  const open = () => { modal.classList.remove('hidden'); msg.style.display='none'; msg.textContent=''; };
  const close = () => { modal.classList.add('hidden'); };

  openBtn?.addEventListener('click', (e) => { e.preventDefault(); open(); });
  cancelBtn?.addEventListener('click', (e) => { e.preventDefault(); close(); });
  modal?.addEventListener('click', (e) => { if (e.target === modal) close(); });

  submitBtn?.addEventListener('click', async (e) => {
    e.preventDefault();
    msg.style.display='none';

    const payload = {
      login: login.value.trim(),
      password: pass.value
    };

    submitBtn.disabled = true;
    try {
      const res = await fetch('/api/create_game_account.php', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      const data = await res.json().catch(()=> ({}));

      if (data.ok) {
  modal.classList.add('hidden');

  notify('success', 'Herní účet byl vytvořen');

  pass.value = '';
  login.value = '';

        await loadGameAccounts();

        setTimeout(() => {
          modal.classList.add('hidden');
        }, 800);
      } else {
  notify('error', data.error || 'Chyba při vytváření účtu');
}
    } finally {
      submitBtn.disabled = false;
    }
  });
})();
</script>

<script>
async function loadGameAccounts() {
  const list = document.getElementById('gameAccountsList');
  const countEl = document.getElementById('accountsCount');

  list.innerHTML = '<div class="muted">Loading game accounts…</div>';

  let res;
  try {
    res = await fetch('/api/list_game_accounts.php');
  } catch (e) {
    list.innerHTML = '<div class="form-error">Server connection error.</div>';
    if (countEl) countEl.textContent = '(0 / 10)';
    return;
  }

  if (!res.ok) {
    list.innerHTML = '<div class="form-error">Unable to load accounts.</div>';
    if (countEl) countEl.textContent = '(0 / 10)';
    return;
  }

  const data = await res.json();

  /* update account count */
  if (countEl) {
    countEl.textContent = `(${data.accounts.length} / 10)`;
  }

  list.innerHTML = '';

  if (!data.ok || !data.accounts.length) {
    list.innerHTML = '<div class="muted">You have no game accounts yet.</div>';
    return;
  }

  data.accounts.forEach(acc => {
  const row = document.createElement('div');
  row.className = 'mini-row';

  const isPrimary = Number(acc.is_primary) === 1;

  if (isPrimary) {
    row.classList.add('primary-account');
  }

  row.innerHTML = `
    <strong>
      ${isPrimary ? '⭐ ' : ''}Account:
    </strong> ${acc.login}

    <span class="tag">${acc.chars_count} characters</span>
    <span class="tag">${acc.created_at}</span>

    <div class="actions">
      ${
        isPrimary
          ? '<span class="tag primary">PRIMARY</span>'
          : `<button class="btn btn-small" data-primary="${acc.login}">
               Primární
             </button>`
      }
      <button class="btn btn-small btn-danger" data-login="${acc.login}">
        Smazat
      </button>
      <button class="btn btn-small" data-reset="${acc.login}">
        Změnit heslo
      </button>
    </div>
  `;

  list.appendChild(row);
});
}
</script>




<script>
document.addEventListener('DOMContentLoaded', () => {
  loadGameAccounts();
});
</script>


<script>
(() => {
  const modal = document.getElementById('deleteModal');
  const input = document.getElementById('deleteConfirmInput');
  const confirmBtn = document.getElementById('deleteConfirm');
  const cancelBtn = document.getElementById('deleteCancel');

  let currentLogin = null;
  const keyword = 'smazat';

  document.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-login]');
    if (!btn) return;

    currentLogin = btn.dataset.login;

    document.getElementById('deleteLogin').textContent = currentLogin;
    document.getElementById('deleteKeyword').textContent = keyword;
    input.value = '';
    confirmBtn.disabled = true;

    modal.classList.remove('hidden');
  });

  input.addEventListener('input', () => {
    confirmBtn.disabled = input.value.trim() !== keyword;
  });

  cancelBtn.addEventListener('click', () => {
    modal.classList.add('hidden');
  });

  confirmBtn.addEventListener('click', async () => {
    confirmBtn.disabled = true;

    const res = await fetch('/api/delete_game_account.php', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ login: currentLogin })
    });

    const data = await res.json().catch(() => ({}));

    if (data.ok) {
      modal.classList.add('hidden');
      notify('success', 'Herní účet byl smazán');
      await loadGameAccounts();
      return;
    }

    if (data.error === 'ACCOUNT_HAS_ACTIVE_CHARACTERS') {
      notify('error', 'Účet má aktivní postavy');
    } else {
      notify('error', 'Nepodařilo se smazat účet');
    }

    confirmBtn.disabled = false;
  });
})();
</script>

<script>
(() => {
  const modal = document.getElementById('resetModal');
  const loginEl = document.getElementById('resetLogin');
  const pass1 = document.getElementById('resetPass1');
  const pass2 = document.getElementById('resetPass2');
  const confirmBtn = document.getElementById('resetConfirm');
  const cancelBtn = document.getElementById('resetCancel');

  let currentLogin = null;

  document.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-reset]');
    if (!btn) return;

    currentLogin = btn.dataset.reset;
    loginEl.textContent = currentLogin;
    pass1.value = '';
    pass2.value = '';
    confirmBtn.disabled = true;

    modal.classList.remove('hidden');
  });

  const validate = () => {
    confirmBtn.disabled =
      pass1.value.length < 6 || pass1.value !== pass2.value;
  };

  pass1.addEventListener('input', validate);
  pass2.addEventListener('input', validate);

  cancelBtn.addEventListener('click', () => {
    modal.classList.add('hidden');
  });

  confirmBtn.addEventListener('click', async () => {
    confirmBtn.disabled = true;

    const res = await fetch('/api/reset_game_password.php', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        login: currentLogin,
        password: pass1.value
      })
    });

    const data = await res.json().catch(() => ({}));

    if (data.ok) {
      modal.classList.add('hidden');
      notify('success', 'Heslo bylo změněno');
      return;
    }

    notify('error', data.error || 'Nepodařilo se resetovat heslo');
    confirmBtn.disabled = false;
  });
})();
</script>

<script>
function notify(type, message, timeout = 3000) {
  const box = document.getElementById('notifications');
  if (!box) return;

  const el = document.createElement('div');
  el.className = `notify ${type}`;
  el.textContent = message;

  box.appendChild(el);

  setTimeout(() => {
    el.style.opacity = '0';
    setTimeout(() => el.remove(), 300);
  }, timeout);
}
</script>

<script>
document.addEventListener('click', async (e) => {
  const btn = e.target.closest('button[data-primary]');
  if (!btn) return;

  const login = btn.dataset.primary;

  const res = await fetch('/api/set_primary_account.php', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ login })
  });

  const data = await res.json().catch(() => ({}));

  if (data.ok) {
    notify('success', 'Primární účet nastaven');
    loadGameAccounts();
  } else {
    notify('error', 'Nastavení primárního účtu se nezdařilo');
  }
});
</script>

<div id="notifications"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const accountSelect = document.getElementById('bugAccount');
  if (!accountSelect) return;

  fetch('/api/list_game_accounts.php')
    .then(r => r.json())
    .then(data => {
      if (!data.ok) return;
      data.accounts.forEach(acc => {
        const opt = document.createElement('option');
        opt.value = acc.login;
        opt.textContent = acc.login;
        accountSelect.appendChild(opt);
      });
    });
});

document.getElementById('bugForm')?.addEventListener('submit', async (e) => {
  e.preventDefault();

  const payload = {
    game_account: document.getElementById('bugAccount').value,
    category: document.getElementById('bugCategory').value,
    title: document.getElementById('bugTitle').value.trim(),
    message: document.getElementById('bugMessage').value.trim()
  };
  if (payload.message.length > 1000) {
  notify('error', 'Text je příliš dlouhý (max. 1000 znaků)');
  return;
}
  const res = await fetch('/api/create_bug_report.php', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });

  const data = await res.json().catch(() => ({}));

  if (data.ok) {
    notify('success', 'Bug report odeslán');
    e.target.reset();
  } else {
    notify('error', data.error || 'Chyba při odesílání');
  }
});
</script>

<script>
(() => {
  const textarea = document.getElementById('bugMessage');
  const counter  = document.getElementById('bugCounter');
  const max = 1000;

  if (!textarea || !counter) return;

  const update = () => {
    const len = textarea.value.length;
    counter.textContent = `${len} / ${max}`;

   counter.classList.remove('warning', 'danger');

if (len > 950) {
  counter.classList.add('danger');
} else if (len > 800) {
  counter.classList.add('warning');
}

  };

  textarea.addEventListener('input', update);
  update();
})();
</script>
<script>
fetch('/api/me.php', { credentials: 'same-origin' })
  .then(res => res.json())
  .then(data => {
    if (data.ok && data.role === 'admin') {
      const btn = document.getElementById('adminBtn');
      if (btn) btn.style.display = 'inline-block';
    }
  })
  .catch(() => {
    // nic – když se nepovede, admin panel se prostě neukáže
  });
</script>


</body>
</html>
