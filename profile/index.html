<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8">
  <title>Profil | Ordo Draconis</title>
  <link rel="stylesheet" href="/css/style.css">
  <link rel="stylesheet" href="/css/profile.css">
</head>

<body class="auth-page profile-page">

<header class="main-header">
  <div class="logo"><a href="/">Ordo Draconis</a></div>
  <div class="auth auth-center">
  <a href="/profile/index.html" class="btn active">Profil</a>
  <a href="/admin/index.html"
   class="btn admin-btn"
   id="adminBtn"
   style="display:none;">
  Admin panel
</a>


  <a href="/api/logout.php" class="btn">Odhl√°sit se</a>
</div>

</header>

<main class="auth-container profile-shell">
  <h1>M≈Øj profil</h1>

  <div class="profile-tabs">
    <button type="button" class="tab active" data-tab="accounts">Hern√≠ √∫ƒçty</button>
    <button type="button" class="tab" data-tab="vote">Hlasov√°n√≠ pro server</button>
    <button type="button" class="tab" data-tab="donate">Podpora serveru</button>
    <button type="button" class="tab" data-tab="support">Hl√°≈°en√≠ bug≈Ø</button>
    <button type="button" class="tab" data-tab="shop">Tr≈æi≈°tƒõ</button>
  </div>

  <div class="profile-panels">
    <section id="accounts" class="profile-card panel active">
      <h2>
  Hern√≠ √∫ƒçty
  <span id="accountsCount" class="muted" style="font-size:14px;">
    (0 / 10)
  </span>
</h2>
      <p class="muted">Zde si vytvo≈ô√≠≈° a spravuje≈° sv√© √∫ƒçty pro Lineage II.</p>

      <a id="createAccBtn" class="btn btn-primary" href="#">Vytvo≈ôit hern√≠ √∫ƒçet</a>

      <div id="accModal" class="modal hidden">
        <div class="modal-box">
          <h3>Vytvo≈ôit hern√≠ √∫ƒçet</h3>

          <label>Login</label>
          <input id="accLogin" type="text" placeholder="4‚Äì16 znak≈Ø (A‚ÄìZ, 0‚Äì9, _)">

          <label>Heslo</label>
          <input id="accPass" type="password" placeholder="min. 6 znak≈Ø">

          <div class="modal-actions">
            <button id="accCancel" class="btn">Zru≈°it</button>
            <button id="accSubmit" class="btn btn-primary">Vytvo≈ôit</button>
          </div>

          <div id="accMsg" class="form-error" style="display:none;"></div>
        </div>
      </div>

<div id="deleteModal" class="modal hidden">
  <div class="modal-box">
    <h3 id="deleteTitle">Smazat √∫ƒçet</h3>

    <p id="deleteText">
      Pro potvrzen√≠ smaz√°n√≠ √∫ƒçtu <strong id="deleteLogin"></strong>
      napi≈° <strong id="deleteKeyword">smazat</strong>.
    </p>

    <input id="deleteConfirmInput" type="text" placeholder="napi≈° smazat">

    <div class="modal-actions">
      <button id="deleteCancel" class="btn">Zru≈°it</button>
      <button id="deleteConfirm" class="btn btn-danger" disabled>
       Smazat √∫ƒçet
      </button>
    </div>

    <div id="deleteMsg" class="form-error" style="display:none;"></div>
  </div>
</div>

<div id="resetModal" class="modal hidden">
  <div class="modal-box">
    <h3>Reset hesla</h3>

    <p>
      Zadej nov√© heslo pro √∫ƒçet <strong id="resetLogin"></strong>.
    </p>

    <input id="resetPass1" type="password" placeholder="Nov√© heslo (min. 6 znak≈Ø)">
    <input id="resetPass2" type="password" placeholder="Potvrzen√≠ hesla">

    <div class="modal-actions">
      <button id="resetCancel" class="btn">Zru≈°it</button>
      <button id="resetConfirm" class="btn btn-primary" disabled>
        Zmƒõnit heslo
      </button>
    </div>

    <div id="resetMsg" class="form-error" style="display:none;"></div>
  </div>
</div>


      <div id="gameAccountsList" class="mini-list"></div>
    </section>

    <section id="vote" class="profile-card panel">
      <h2>Hlasov√°n√≠ pro server</h2>
      <div id="voteBalance" class="wallet-balance">
  Vote Coin: <strong>0</strong>
</div>
<div id="dcBalance" class="wallet-balance">
  Dragon Coin: <strong>0</strong>
</div>
     <p class="muted">
  Klikni na web a odhlasuj. Seznam se naƒç√≠t√° automaticky z datab√°ze (v≈°echny aktivn√≠ vote weby).
</p>

<div class="link-list">
  <div class="muted">Naƒç√≠t√°m vote weby‚Ä¶</div>
</div>

  <hr style="margin:20px 0;">
  <button id="convertVcToDc" class="btn btn-primary">
    P≈ôevod 4 Vote Coin ‚Üí 1 Dragon Coin
  </button>
<button id="openVipModal" class="btn btn-primary">
  Activace VIP 24h
</button>

<div id="vipModal" class="modal hidden">
  <div class="modal-box">
    <h3>Activate VIP 24 Hours</h3>
    <label>Character</label>
    <select id="vipCharSelect"></select>

    <label>Currency</label>
    <select id="vipCurrency">
      <option value="VOTE_COIN">4 Vote Coin</option>
      <option value="DC">1 Dragon Coin</option>
    </select>

    <div class="modal-actions">
      <button id="vipCancel" class="btn">Cancel</button>
      <button id="vipConfirm" class="btn btn-primary">
        Activate
      </button>
    </div>
  </div>
</div>
    </section>

<section id="shop" class="profile-card panel">
  <h2>Tr≈æi≈°tƒõ</h2>
<p class="muted">N√°kup za Dragon Coin (DC).</p>

<div class="profile-tabs" style="margin:10px 0 14px;">
  <button type="button" class="tab active" data-shop-tab="premium">Premium</button>
  <button type="button" class="tab" data-shop-tab="mounts">Mounty</button>
  <button type="button" class="tab" data-shop-tab="cosmetic">Vzhled</button>
</div>

<div id="shopMsg" class="muted" style="margin-bottom:10px; display:none;"></div>

<div id="shopPremium" class="link-list"></div>
<div id="shopMounts" class="link-list" style="display:none;"></div>
<div id="shopCosmetic" class="link-list" style="display:none;"></div>
</section>

      <section id="donate" class="profile-card panel">
  <h2>Podpora serveru</h2>
  <p class="muted">≈Ω√°dn√© pay-to-win. Zde budou informace k podpo≈ôe serveru.</p>

  <div class="donate-box">
    <div><strong>IBAN:</strong> XXXX XXXX XXXX</div>
    <div><strong>Zpr√°va pro p≈ô√≠jemce:</strong> tv≈Øj e-mail / √∫ƒçet</div>
  </div>
</section>

    <section id="support" class="profile-card panel">
  <h2>Hl√°≈°en√≠ bug≈Ø</h2>
  <p class="muted">Nƒõco nefunguje? Po≈°li n√°m detailn√≠ popis probl√©mu.</p>

  <form id="bugForm">
    <label>Hern√≠ √∫ƒçet (voliteln√©)</label>
    <select id="bugAccount">
      <option value="">‚Äî vyber √∫ƒçet ‚Äî</option>

    </select>

    <label>Kategorie</label>
    <select id="bugCategory" required>
      <option value="">‚Äî vyber kategorii ‚Äî</option>
      <option value="quest">Quest</option>
      <option value="npc">NPC / AI</option>
      <option value="item">Item</option>
      <option value="skill">Skill</option>
      <option value="login">P≈ôihl√°≈°en√≠</option>
      <option value="other">Jin√©</option>
    </select>

    <label>N√°zev probl√©mu</label>
    <input id="bugTitle" type="text" maxlength="40" required>

    <label>Popis probl√©mu</label>
    <textarea id="bugMessage" rows="6" maxlength="1000" required></textarea>
    <div id="bugCounter" class="char-counter">0 / 1000</div>
    <button class="btn btn-primary" type="submit">
      Odeslat hl√°≈°en√≠
    </button>
  </form>
  <hr style="margin:30px 0;">

<h3>Moje hl√°≈°en√≠</h3>
<div id="myBugs" class="link-list">
  <div class="muted">Naƒç√≠t√°m hl√°≈°en√≠‚Ä¶</div>
</div>
</section>

  </div>
</main>

<script>
document.addEventListener('DOMContentLoaded', async () => {

  try {
    const res = await fetch('/api/me.php', { credentials: 'same-origin' });
    const data = await res.json();

    if (!data.ok) {
      const isEn = document.documentElement.lang === 'en';
      window.location.href = isEn
        ? '/auth/login-en.html'
        : '/auth/login.html';
      return;
    }

    // üî• WEB VIP ZOBRAZEN√ç
    if (data.web_vip) {
      const vipBox = document.createElement("div");
      vipBox.className = "profile-vip-box";
      vipBox.innerHTML = `
        <strong>WEB VIP aktivn√≠</strong><br>
        Plat√≠ do: ${data.web_vip.end_at}<br>
        Zb√Ωv√° dn√≠: ${data.web_vip.days_left}
      `;
      document.querySelector(".auth-container").prepend(vipBox);
    }

  } catch (e) {
    window.location.href = '/auth/login.html';
  }

});
</script>




<script>
document.addEventListener('DOMContentLoaded', () => {
  const tabs = document.querySelectorAll('.profile-tabs .tab');
  const panels = document.querySelectorAll('.profile-panels .panel');

  const show = (key) => {
    tabs.forEach(t => t.classList.toggle('active', t.dataset.tab === key));
    panels.forEach(p => p.classList.toggle('active', p.id === key));
  };
  tabs.forEach(t => t.addEventListener('click', () => show(t.dataset.tab)));
  const first = document.querySelector('.profile-tabs .tab.active') || tabs[0];
  if (first) show(first.dataset.tab);
  const params = new URLSearchParams(window.location.search);
const tab = params.get('tab');

if (tab) {
  const btn = document.querySelector(`[data-tab="${tab}"]`);
  if (btn) {
    btn.click();
  }
}

});
</script>

<script>
(() => {
  const modal = document.getElementById('accModal');
  const openBtn = document.getElementById('createAccBtn');
  const cancelBtn = document.getElementById('accCancel');
  const submitBtn = document.getElementById('accSubmit');
  const msg = document.getElementById('accMsg');

  const login = document.getElementById('accLogin');
  const pass  = document.getElementById('accPass');

  const open = () => { modal.classList.remove('hidden'); msg.style.display='none'; msg.textContent=''; };
  const close = () => { modal.classList.add('hidden'); };

  openBtn?.addEventListener('click', (e) => { e.preventDefault(); open(); });
  cancelBtn?.addEventListener('click', (e) => { e.preventDefault(); close(); });
  modal?.addEventListener('click', (e) => { if (e.target === modal) close(); });

  submitBtn?.addEventListener('click', async (e) => {
    e.preventDefault();
    msg.style.display='none';

    const payload = {
      login: login.value.trim(),
      password: pass.value
    };

    submitBtn.disabled = true;
    try {
      const res = await fetch('/api/create_game_account.php', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      const data = await res.json().catch(()=> ({}));

      if (data.ok) {
  modal.classList.add('hidden');

  notify('success', 'Hern√≠ √∫ƒçet byl vytvo≈ôen');

  pass.value = '';
  login.value = '';

        await loadGameAccounts();

        setTimeout(() => {
          modal.classList.add('hidden');
        }, 800);
      } else {
  notify('error', data.error || 'Chyba p≈ôi vytv√°≈ôen√≠ √∫ƒçtu');
}
    } finally {
      submitBtn.disabled = false;
    }
  });
})();
</script>

<script>
async function loadGameAccounts() {
  const list = document.getElementById('gameAccountsList');
  const countEl = document.getElementById('accountsCount');

  list.innerHTML = '<div class="muted">Loading game accounts‚Ä¶</div>';

  let res;
  try {
    res = await fetch('/api/list_game_accounts.php');
  } catch (e) {
    list.innerHTML = '<div class="form-error">Server connection error.</div>';
    if (countEl) countEl.textContent = '(0 / 10)';
    return;
  }

  if (!res.ok) {
    list.innerHTML = '<div class="form-error">Unable to load accounts.</div>';
    if (countEl) countEl.textContent = '(0 / 10)';
    return;
  }

  const data = await res.json();

  /* update account count */
  if (countEl) {
    countEl.textContent = `(${data.accounts.length} / 10)`;
  }

  list.innerHTML = '';

  if (!data.ok || !data.accounts.length) {
    list.innerHTML = '<div class="muted">You have no game accounts yet.</div>';
    return;
  }

  data.accounts.forEach(acc => {
  const row = document.createElement('div');
  row.className = 'mini-row';

  const isPrimary = Number(acc.is_primary) === 1;

  if (isPrimary) {
    row.classList.add('primary-account');
  }

 const premiumTag = (() => {
  if (acc.premium_days_left === null) {
    return `<span class="tag muted">Premium: neaktivn√≠</span>`;
  }

  if (acc.premium_days_left < 0) {
    return `<span class="tag danger">Premium: expirov√°no</span>`;
  }

  if (acc.premium_days_left <= 3) {
    return `<span class="tag warning">
      Premium: ${acc.premium_days_left} dny
    </span>`;
  }

  return `<span class="tag success">
    Premium: ${acc.premium_days_left} dn√≠
  </span>`;
})();

row.innerHTML = `
  <div class="account-row" data-login="${acc.login}">
    <strong>${isPrimary ? '‚≠ê ' : ''}Account:</strong> ${acc.login}

    <span class="tag">${acc.chars_count} characters</span>
    ${premiumTag}
${acc.premium_end_at 
  ? `<span class="tag">${acc.premium_end_at}</span>` 
  : `<span class="tag">${acc.created_at}</span>`
}

    <div class="actions">
      ${isPrimary
        ? '<span class="tag primary">PRIMARY</span>'
        : `<button class="btn btn-small" data-primary="${acc.login}">Set primary</button>`
      }
      <button class="btn btn-small btn-danger" data-login="${acc.login}">Delete</button>
      <button class="btn btn-small" data-reset="${acc.login}">Change password</button>
    </div>
  </div>

  <div class="char-list hidden" id="chars-${acc.login}"></div>
`;


  list.appendChild(row);
});
}
</script>




<script>
document.addEventListener('DOMContentLoaded', () => {
  loadGameAccounts();
});
</script>


<script>
(() => {
  const modal = document.getElementById('deleteModal');
  const input = document.getElementById('deleteConfirmInput');
  const confirmBtn = document.getElementById('deleteConfirm');
  const cancelBtn = document.getElementById('deleteCancel');

  let currentLogin = null;
  const keyword = 'smazat';

  document.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-login]');
    if (!btn) return;

    currentLogin = btn.dataset.login;

    document.getElementById('deleteLogin').textContent = currentLogin;
    document.getElementById('deleteKeyword').textContent = keyword;
    input.value = '';
    confirmBtn.disabled = true;

    modal.classList.remove('hidden');
  });

  input.addEventListener('input', () => {
    confirmBtn.disabled = input.value.trim() !== keyword;
  });

  cancelBtn.addEventListener('click', () => {
    modal.classList.add('hidden');
  });

  confirmBtn.addEventListener('click', async () => {
    confirmBtn.disabled = true;

    const res = await fetch('/api/delete_game_account.php', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ login: currentLogin })
    });

    const data = await res.json().catch(() => ({}));

    if (data.ok) {
      modal.classList.add('hidden');
      notify('success', 'Hern√≠ √∫ƒçet byl smaz√°n');
      await loadGameAccounts();
      return;
    }

    if (data.error === 'ACCOUNT_HAS_ACTIVE_CHARACTERS') {
      notify('error', '√öƒçet m√° aktivn√≠ postavy');
    } else {
      notify('error', 'Nepoda≈ôilo se smazat √∫ƒçet');
    }

    confirmBtn.disabled = false;
  });
})();
</script>

<script>
(() => {
  const modal = document.getElementById('resetModal');
  const loginEl = document.getElementById('resetLogin');
  const pass1 = document.getElementById('resetPass1');
  const pass2 = document.getElementById('resetPass2');
  const confirmBtn = document.getElementById('resetConfirm');
  const cancelBtn = document.getElementById('resetCancel');

  let currentLogin = null;

  document.addEventListener('click', (e) => {
    const btn = e.target.closest('button[data-reset]');
    if (!btn) return;

    currentLogin = btn.dataset.reset;
    loginEl.textContent = currentLogin;
    pass1.value = '';
    pass2.value = '';
    confirmBtn.disabled = true;

    modal.classList.remove('hidden');
  });

  const validate = () => {
    confirmBtn.disabled =
      pass1.value.length < 6 || pass1.value !== pass2.value;
  };

  pass1.addEventListener('input', validate);
  pass2.addEventListener('input', validate);

  cancelBtn.addEventListener('click', () => {
    modal.classList.add('hidden');
  });

  confirmBtn.addEventListener('click', async () => {
    confirmBtn.disabled = true;

    const res = await fetch('/api/reset_game_password.php', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({
        login: currentLogin,
        password: pass1.value
      })
    });

    const data = await res.json().catch(() => ({}));

    if (data.ok) {
      modal.classList.add('hidden');
      notify('success', 'Heslo bylo zmƒõnƒõno');
      return;
    }

    notify('error', data.error || 'Nepoda≈ôilo se resetovat heslo');
    confirmBtn.disabled = false;
  });
})();
</script>

<script>
function notify(type, message, timeout = 3000) {
  const box = document.getElementById('notifications');
  if (!box) return;

  const el = document.createElement('div');
  el.className = `notify ${type}`;
  el.textContent = message;

  box.appendChild(el);

  setTimeout(() => {
    el.style.opacity = '0';
    setTimeout(() => el.remove(), 300);
  }, timeout);
}
</script>

<script>
document.addEventListener('click', async (e) => {
  const btn = e.target.closest('button[data-primary]');
  if (!btn) return;

  const login = btn.dataset.primary;

  const res = await fetch('/api/set_primary_account.php', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ login })
  });

  const data = await res.json().catch(() => ({}));

  if (data.ok) {
    notify('success', 'Prim√°rn√≠ √∫ƒçet nastaven');
    loadGameAccounts();
  } else {
    notify('error', 'Nastaven√≠ prim√°rn√≠ho √∫ƒçtu se nezda≈ôilo');
  }
});
</script>

<div id="notifications"></div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const accountSelect = document.getElementById('bugAccount');
  if (!accountSelect) return;

  fetch('/api/list_game_accounts.php')
    .then(r => r.json())
    .then(data => {
      if (!data.ok) return;
      data.accounts.forEach(acc => {
        const opt = document.createElement('option');
        opt.value = acc.login;
        opt.textContent = acc.login;
        accountSelect.appendChild(opt);
      });
    });
});

document.getElementById('bugForm')?.addEventListener('submit', async (e) => {
  e.preventDefault();

  const payload = {
    game_account: document.getElementById('bugAccount').value,
    category: document.getElementById('bugCategory').value,
    title: document.getElementById('bugTitle').value.trim(),
    message: document.getElementById('bugMessage').value.trim()
  };
  if (payload.message.length > 1000) {
  notify('error', 'Text je p≈ô√≠li≈° dlouh√Ω (max. 1000 znak≈Ø)');
  return;
}
  const res = await fetch('/api/create_bug_report.php', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });

  const data = await res.json().catch(() => ({}));

  if (data.ok) {
    notify('success', 'Bug report odesl√°n');
    e.target.reset();
  } else {
    notify('error', data.error || 'Chyba p≈ôi odes√≠l√°n√≠');
  }
});
</script>

<script>
(() => {
  const textarea = document.getElementById('bugMessage');
  const counter  = document.getElementById('bugCounter');
  const max = 1000;

  if (!textarea || !counter) return;

  const update = () => {
    const len = textarea.value.length;
    counter.textContent = `${len} / ${max}`;

   counter.classList.remove('warning', 'danger');

if (len > 950) {
  counter.classList.add('danger');
} else if (len > 800) {
  counter.classList.add('warning');
}

  };

  textarea.addEventListener('input', update);
  update();
})();
</script>
<script>
document.addEventListener('DOMContentLoaded', async () => {
  try {
    const res = await fetch('/api/me.php', {
      credentials: 'same-origin'
    });
    const me = await res.json();

    if (me.ok && me.role === 'admin') {
      const btn = document.getElementById('adminBtn');
      if (btn) {
        btn.style.display = 'inline-flex';
      }
    }
  } catch (e) {
    // kdy≈æ se nepovede, admin tlaƒç√≠tko z≈Østane skryt√©
  }
});
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const box = document.getElementById('myBugs');
  if (!box) return;

  fetch('/api/list_my_bug_reports.php')
    .then(r => r.json())
    .then(data => {
      if (!data.ok) {
        box.innerHTML = '<div class="muted">≈Ω√°dn√° hl√°≈°en√≠</div>';
        return;
      }

      box.innerHTML = '';

      data.bugs.forEach(bug => {
        const row = document.createElement('a');
        row.href = `/profile/bug_detail.html?id=${bug.id}`;
        row.className = 'link-item';

        row.innerHTML = `
          <strong>[${bug.status.toUpperCase()}]</strong>
          ${bug.title}
        `;

        box.appendChild(row);
      });
    });
});
</script>

<script>
async function loadVipMap(login) {
  const res = await fetch(`/api/list_characters_with_vip.php?account=${encodeURIComponent(login)}`);
  const data = await res.json();

  const map = {};

  if (data.ok && Array.isArray(data.characters)) {
    data.characters.forEach(ch => {

      map[ch.charId] = {
        hasVip: !!ch.has_vip,
        endAt: ch.vip_end_at || null
      };

    });
  }

  return map;
}
</script>



<script>
document.addEventListener('click', async (e) => {
  const row = e.target.closest('.account-row');
  if (!row) return;

  const login = row.dataset.login;
  const box = document.getElementById('chars-' + login);
  if (!box) return;

  /* toggle */
  if (!box.classList.contains('hidden')) {
    box.classList.add('hidden');
    box.innerHTML = '';
    return;
  }

  box.classList.remove('hidden');
  box.innerHTML = '<div class="muted">Loading characters‚Ä¶</div>';

  try {
    /* 1Ô∏è‚É£ naƒçteme VIP mapu */
    const vipMap = await loadVipMap(login);

    /* 2Ô∏è‚É£ naƒçteme postavy (p≈Øvodn√≠ API) */
    const res = await fetch(`/api/list_characters.php?account=${encodeURIComponent(login)}`);
    const data = await res.json();

    if (!data.ok || !data.characters.length) {
      box.innerHTML = '<div class="muted">No characters</div>';
      return;
    }

    box.innerHTML = '';

    /* 3Ô∏è‚É£ vykreslen√≠ postav */
    data.characters.forEach(ch => {
      const el = document.createElement('div');
      el.className = 'char-row';

      const vipData = vipMap[ch.charId];

let vipTag = '';

if (vipData && vipData.hasVip) {
  vipTag = `
    <span class="tag vip">
      VIP do ${vipData.endAt}
    </span>
  `;
}


      el.innerHTML = `
        <span><strong>${ch.char_name}</strong></span>
        <span>Lv ${ch.level}</span>
        <span class="${ch.online ? 'online' : 'offline'}">
          ${ch.online ? 'ONLINE' : 'offline'}
        </span>
        ${vipTag}
      `;

      box.appendChild(el);
    });

  } catch (err) {
    box.innerHTML = '<div class="form-error">Failed to load characters</div>';
  }
});
</script>

<script>
let voteCache = [];
let voteBusy = false;

const i18n = (() => {
  const en = (document.documentElement.lang || '').toLowerCase() === 'en';
  return {
    en,
    txt: {
      noSites: en ? 'No active vote sites.' : '≈Ω√°dn√© aktivn√≠ vote weby.',
      ready: 'READY',
      cooldown: en ? 'Vote is on cooldown.' : 'Vote je v cooldownu.',
      cooldownLeft: en ? 'Cooldown remaining: ' : 'Zb√Ωv√° cooldown: ',
      startError: en ? 'Failed to start vote.' : 'Nepoda≈ôilo se spustit vote.',
      openHint: en ? 'Vote page opened. Waiting for verification‚Ä¶' : 'Vote str√°nka otev≈ôena. ƒåek√°m na ovƒõ≈ôen√≠‚Ä¶',
      needConfirm: en ? 'Confirm you voted?' : 'Potvrdit, ≈æe jsi hlasoval?',
      rewarded: en ? 'Vote Coin added!' : 'Vote Coin p≈ôips√°n!',
      pendingLater: en ? 'Not detected yet. Try again later.' : 'Zat√≠m nedetekov√°no. Zkus to pozdƒõji.',
      unknownErr: en ? 'Unknown error.' : 'Nezn√°m√° chyba.'
    }
  };
})();

/* Naƒçten√≠ vote web≈Ø */
async function loadVoteSites() {
  try {
    const res = await fetch('/api/vote_status.php', { credentials: 'same-origin' });
    const data = await res.json();
    if (!data.ok) return;

    voteCache = data.sites || [];

    const box = document.querySelector('#vote .link-list');
    if (!box) return;

    box.innerHTML = '';

    if (!voteCache.length) {
      box.innerHTML = `<div class="muted">${i18n.txt.noSites}</div>`;
      return;
    }

    voteCache.forEach(site => {
      const el = document.createElement('div');

      const status = (() => {
  const rem = Number(site.remaining || 0);
  if (rem <= 0) return i18n.txt.ready;

  const h = Math.floor(rem / 3600);
  const m = Math.floor((rem % 3600) / 60);

  if (h <= 0) return `${m}m`;
  return `${h}h ${m}m`;
})();

      const disabled = site.remaining > 0 ? 'disabled' : '';

      el.innerHTML = `
        <button class="btn vote-btn" data-id="${site.id}" ${disabled}>
          ${site.name} ‚Äì ${status}
        </button>
      `;

      box.appendChild(el);
    });

  } catch (err) {
    console.error('Vote load error:', err);
  }
}

/* Spu≈°tƒõn√≠ vote (vytvo≈ô√≠ attempt + otev≈ôe URL) */
async function startVote(siteId, btnEl) {
  if (voteBusy) return;
  voteBusy = true;

  try {
    btnEl && (btnEl.disabled = true);

    const res = await fetch('/api/vote_start.php', {
      method: 'POST',
      credentials: 'same-origin',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ site_id: siteId })
    });

    const data = await res.json().catch(() => ({}));

    if (!data.ok) {
      if (data.error === 'COOLDOWN') {
        const rem = typeof data.remaining === 'number' ? data.remaining : 0;
        notify?.('error', `${i18n.txt.cooldown} ${i18n.txt.cooldownLeft}${rem}s`);
        await loadVoteSites();
        return;
      }
      notify?.('error', `${i18n.txt.startError} ${data.error || ''}`.trim());
      return;
    }

    // otev≈ôi vote str√°nku (URL bere z DB)
    window.open(data.vote_url, '_blank');
    notify?.('success', i18n.txt.openHint, 3500);

    // polling ovƒõ≈ôen√≠
    await pollVote(data.attempt_id);

  } catch (err) {
    console.error('Vote start error:', err);
    notify?.('error', i18n.txt.startError);
  } finally {
    voteBusy = false;
    btnEl && (btnEl.disabled = false);
  }
}

/* Polling vote_check (nejd≈ô√≠v bez confirm; pokud backend chce confirm, zept√° se a≈æ potom) */
async function pollVote(attemptId) {
  const start = Date.now();
  const maxMs = 90000; // 90s
  const waitMs = 4000; // 4s
  let manualConfirm = false;
  let askedConfirm = false;

  while (Date.now() - start < maxMs) {
    const res = await fetch('/api/vote_check.php', {
      method: 'POST',
      credentials: 'same-origin',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ attempt_id: attemptId, confirm: manualConfirm })
    });

    const data = await res.json().catch(() => ({}));

    if (!data.ok) {
      if (data.error === 'COOLDOWN') {
        notify?.('error', i18n.txt.cooldown);
        await loadVoteSites();
        return;
      }
      notify?.('error', data.error || i18n.txt.unknownErr);
      return;
    }

    if (data.status === 'REWARDED' || data.status === 'USED') {
      notify?.('success', i18n.txt.rewarded);
      await loadVoteSites();
      if (typeof loadVoteBalance === 'function') loadVoteBalance();
      return;
    }

    // MANUAL fallback ‚Äì backend ≈ôekne WAITING_CONFIRM
    if (data.status === 'WAITING_CONFIRM' && !askedConfirm) {
      askedConfirm = true;
      manualConfirm = confirm(i18n.txt.needConfirm);
      // kdy≈æ d√° Cancel, nech√°me manualConfirm=false a budeme jen ƒçekat do timeoutu
    }

    await new Promise(r => setTimeout(r, waitMs));
  }

  notify?.('error', i18n.txt.pendingLater);
  await loadVoteSites();
}

/* Kliknut√≠ na vote */
document.addEventListener('click', (e) => {
  const btn = e.target.closest('.vote-btn');
  if (!btn) return;

  const id = parseInt(btn.dataset.id, 10);
  if (!id) return;

  startVote(id, btn);
});

/* inicializace */
document.addEventListener('DOMContentLoaded', loadVoteSites);
</script>



<script>
async function loadVoteBalance() {
  try {
    const res = await fetch('/api/get_wallet_balance.php?currency=VOTE_COIN');
    const data = await res.json();
    if (!data.ok) return;

    const el = document.querySelector('#voteBalance strong');
    if (el) {
      el.textContent = data.balance;
    }

  } catch (err) {
    console.error('Vote balance error:', err);
  }
}

async function loadDcBalance() {
  try {
    const res = await fetch('/api/get_wallet_balance.php?currency=DC');
    const data = await res.json();
    if (!data.ok) return;

    const el = document.querySelector('#dcBalance strong');
    if (el) {
      el.textContent = data.balance;
    }

  } catch (err) {
    console.error('DC balance error:', err);
  }
}

/* üîÑ naƒçten√≠ obou p≈ôi startu str√°nky */
document.addEventListener('DOMContentLoaded', () => {
  loadVoteBalance();
  loadDcBalance();
});
</script>

<script>
async function loadAllCharactersForVip() {
  const select = document.getElementById('vipCharSelect');
  select.innerHTML = '';

  const resAcc = await fetch('/api/list_game_accounts.php');
  const dataAcc = await resAcc.json();
  if (!dataAcc.ok) return;

  for (const acc of dataAcc.accounts) {
    const resChar = await fetch(`/api/list_characters.php?account=${encodeURIComponent(acc.login)}`);
    const dataChar = await resChar.json();
    if (!dataChar.ok) continue;

    dataChar.characters.forEach(ch => {
      const opt = document.createElement('option');
      opt.value = ch.charId;
      opt.textContent = `${ch.char_name} (Lv ${ch.level})`;
      select.appendChild(opt);
    });
  }
}

document.getElementById('openVipModal')?.addEventListener('click', async () => {
  await loadAllCharactersForVip();
  document.getElementById('vipModal').classList.remove('hidden');
});

document.getElementById('vipCancel')?.addEventListener('click', () => {
  document.getElementById('vipModal').classList.add('hidden');
});

document.getElementById('vipConfirm')?.addEventListener('click', async (e) => {

  const btn = e.target;
  if (btn.disabled) return;

  btn.disabled = true;
  btn.textContent = 'Activating...';

  const charId = document.getElementById('vipCharSelect').value;
  const currency = document.getElementById('vipCurrency').value;

  try {
    const res = await fetch('/api/activate_vip_24h.php', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
        char_id: charId,
        currency: currency
      })
    });

    const data = await res.json();

    if (data.ok) {
      document.getElementById('vipModal').classList.add('hidden');
      loadVoteBalance();
      loadDcBalance();
    } else {
      alert(data.error || 'Activation failed.');
    }

  } catch (err) {
    alert('Server error.');
  }

  btn.disabled = false;
  btn.textContent = 'Activate';
});
</script>

<script>
document.getElementById('convertVcToDc')?.addEventListener('click', async (e) => {

  const btn = e.target;
  if (btn.disabled) return;

  if (!confirm('Convert 4 Vote Coin into 1 Dragon Coin?')) {
    return;
  }

  btn.disabled = true;
  btn.textContent = 'Processing...';

  try {
    const res = await fetch('/api/convert_vc_to_dc.php', {
      method: 'POST',
      headers: {'Content-Type':'application/json'}
    });

    const data = await res.json();

    if (data.ok) {
      loadVoteBalance();
      loadDcBalance();
    } else {
      alert(data.error || 'Conversion failed.');
    }

  } catch (err) {
    alert('Server error.');
  }

  btn.disabled = false;
  btn.textContent = 'Convert 4 Vote Coin ‚Üí 1 Dragon Coin';
});
</script>

<script>
let shopProducts = [];
let myGameAccounts = [];

async function loadShop() {
  const box = document.getElementById('shopPremium');
  if (!box) return;

  box.innerHTML = '<div class="muted">Naƒç√≠t√°m produkty‚Ä¶</div>';

  const [pRes, aRes] = await Promise.all([
    fetch('/api/shop_list.php', {credentials:'same-origin'}),
    fetch('/api/list_game_accounts_min.php', {credentials:'same-origin'})
  ]);

  const pData = await pRes.json().catch(()=>({}));
  const aData = await aRes.json().catch(()=>({}));

  shopProducts = (pData.ok && Array.isArray(pData.products)) ? pData.products : [];
  myGameAccounts = (aData.ok && Array.isArray(aData.accounts)) ? aData.accounts : [];

  box.innerHTML = '';

  if (!shopProducts.length) {
    box.innerHTML = '<div class="muted">≈Ω√°dn√© produkty.</div>';
    return;
  }

  shopProducts.forEach(prod => {
    const row = document.createElement('div');
    row.className = 'mini-row';

    const needsGameAcc = prod.code === 'PREM_GAME_30D';

    const selectHtml = needsGameAcc ? `
      <select class="shop-acc" data-pid="${prod.id}">
        ${myGameAccounts.map(a => `<option value="${a.id}">${a.login}</option>`).join('')}
      </select>
    ` : '';

    row.innerHTML = `
      <div class="mini-row">
        <div>
          <strong>${prod.name}</strong><br>
          <span class="muted">${prod.description || ''}</span>
        </div>

        <div style="display:flex; gap:10px; align-items:center; justify-content:flex-end;">
          ${selectHtml}
          <span class="tag">${prod.price_dc} DC</span>
          <button class="btn btn-small btn-primary shop-buy" data-id="${prod.id}">
            Koupit
          </button>
        </div>
      </div>
    `;

    box.appendChild(row);
  });
}

document.addEventListener('click', async (e) => {
  const btn = e.target.closest('.shop-buy');
  if (!btn) return;

  const productId = parseInt(btn.dataset.id, 10);
  if (!productId) return;

  const prod = shopProducts.find(p => Number(p.id) === productId);
  if (!prod) return;

  btn.disabled = true;

  try {
    const payload = { product_id: productId };

    if (prod.code === 'PREM_GAME_30D') {
      const sel = document.querySelector(`.shop-acc[data-pid="${productId}"]`);
      const gaId = parseInt(sel?.value || '0', 10);
      if (!gaId) {
        notify?.('error', 'Vyber hern√≠ √∫ƒçet');
        btn.disabled = false;
        return;
      }
      payload.game_account_id = gaId;
    }

    const res = await fetch('/api/shop_buy.php', {
      method: 'POST',
      credentials: 'same-origin',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify(payload)
    });

    const data = await res.json().catch(()=>({}));

    if (data.ok) {
      notify?.('success', 'N√°kup dokonƒçen');
      if (typeof loadDcBalance === 'function') loadDcBalance();
      if (typeof loadVoteBalance === 'function') loadVoteBalance();
      return;
    }

    const err = data.error || 'Chyba n√°kupu';
    if (err === 'INSUFFICIENT_FUNDS') notify?.('error', 'Nedostatek DC');
    else if (err === 'ALREADY_PURCHASED') notify?.('error', 'U≈æ koupeno');
    else notify?.('error', err);

  } finally {
    btn.disabled = false;
  }
});
function initShopSubTabs() {
  const btns = document.querySelectorAll('#shop [data-shop-tab]');
  const panes = {
    premium: document.getElementById('shopPremium'),
    mounts: document.getElementById('shopMounts'),
    cosmetic: document.getElementById('shopCosmetic')
  };

  btns.forEach(b => b.addEventListener('click', () => {
    const key = b.dataset.shopTab;
    btns.forEach(x => x.classList.toggle('active', x === b));
    Object.entries(panes).forEach(([k, el]) => {
      if (!el) return;
      el.style.display = (k === key) ? '' : 'none';
    });
  }));
}
document.addEventListener('DOMContentLoaded', () => {
  // naƒçti shop, a≈æ kdy≈æ u≈æivatel p≈ôepne na tab (u≈°et≈ô√≠me requesty)
  document.querySelector('[data-tab="shop"]')?.addEventListener('click', () => {
  initShopSubTabs();
  loadShop();
});
});
</script>

</body>
</html>
